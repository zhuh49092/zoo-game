<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>精灵中心 - 夢見ヶ崎動物勇者団</title>
  <style>
    html,body{margin:0;background:#000;}
    /* 使用可缩放画布：宽度填满，维持 9:16 */
    .sp-canvas{ position:relative; width:min(100vw, 720px); height:calc(min(100vw, 720px) * (16 / 9)); max-height:100vh; margin:0 auto; background:#fff; overflow:hidden; touch-action:none; }
    .sp-bg{ position:absolute; inset:0; background:url('assets/bg/garden.jpg') center/cover no-repeat; transform-origin:0 0; z-index:0; }
    .sp-content{ position:absolute; inset:0; z-index:1; }
    .sp-world{ position:absolute; inset:0; transform-origin:0 0; }
    .sp-btn-map{ position:absolute; right:20px; top:20px; z-index:9; width:clamp(56px, 9vw, 72px); height:clamp(56px, 9vw, 72px); background:url('assets/ui/btn_map.png') center/contain no-repeat; border:none; outline:none; cursor:pointer; }
    .sp-title{ position:absolute; left:20px; top:20px; width:clamp(180px, 25vw, 220px); height:clamp(50px, 7vh, 60px); background:url('assets/ui/title_seirei_garden.png') left top / contain no-repeat; }
    .sp-bars{ position:absolute; left:clamp(16px, 12vw, 110px); top:clamp(56px, 10vh, 160px); width:clamp(240px, 78vw, 520px); }
    .sp-row{ display:flex; align-items:center; gap:clamp(8px, 2.5vw, 14px); margin:clamp(10px, 2vh, 22px) 0; }
    .sp-row .sp-icon{ width:clamp(28px, 6vw, 40px); height:clamp(28px, 6vw, 40px); background-size:contain; background-repeat:no-repeat; background-position:center; flex:0 0 auto; }
    .sp-row .sp-icon.sp-forest{ background-image:url('assets/ui/icon_forest.png'); }
    .sp-row .sp-icon.sp-water { background-image:url('assets/ui/icon_water.png'); }
    .sp-row .sp-icon.sp-grass { background-image:url('assets/ui/icon_grass.png'); }
    .sp-seg3{ display:flex; gap:clamp(8px, 2vw, 14px); flex:1 1 auto; }
    .sp-seg{ flex:1 1 0; min-width:0; height:clamp(14px, 2.8vh, 22px); border-radius:999px; background:rgba(255,255,255,0.65); box-shadow:inset 0 0 0 2px rgba(0,0,0,0.08); overflow:hidden; }
    .sp-seg i{ display:block; height:100%; width:0%; }
    .sp-forest .sp-seg i{ background:#2f8f3a; }
    .sp-water  .sp-seg i{ background:#2da8f8; }
    .sp-grass  .sp-seg i{ background:#87c96a; }
    .sp-playground{ position:absolute; left:0; right:0; top:0; bottom:0; overflow:hidden; }
    .sp-sprite{ position:absolute; pointer-events:auto; user-select:none; transform:translate3d(0,0,0); }
    .sp-sprite img{ width:100%; height:100%; display:block; pointer-events:none; }
    @media (max-height: 700px){ .sp-bars{ top:clamp(48px, 10vh, 120px); } }

    /* ===== 新手指引（贴在画布内，PNG 叠加；层级最高） ===== */
    #guide-spirit{
      position:absolute; inset:0;
      z-index:2147483648;
      display:none; align-items:center; justify-content:center;
      background:transparent;
      touch-action:manipulation;
    }
    #guide-spirit.show{ display:flex; }
    #guide-spirit img{
      width:100%; height:100%;
      max-width:none; max-height:none;
      object-fit:cover;
      user-select:none; -webkit-user-drag:none; pointer-events:none;
      display:block;
    }
    #guide-spirit button{
      position:absolute; right:12px; top:calc(12px + env(safe-area-inset-top));
      padding:6px 14px; border:0; border-radius:999px;
      background:rgba(0,0,0,.35); color:#fff; font-weight:700; font-size:16px;
      cursor:pointer; z-index:2147483649;
    }
  </style>
</head>
<body>
  <div class="sp-canvas" id="sp-canvas">
    <div class="sp-bg" id="sp-bg"></div>
    <button class="sp-btn-map" id="sp-btnMap" title="返回地图"></button>

    <div class="sp-content" id="sp-content">
      <div class="sp-title"></div>
      <div class="sp-bars">
        <div class="sp-row sp-forest"><div class="sp-icon sp-forest"></div><div class="sp-seg3"><div class="sp-seg"><i id="f1"></i></div><div class="sp-seg"><i id="f2"></i></div><div class="sp-seg"><i id="f3"></i></div></div></div>
        <div class="sp-row sp-water"><div class="sp-icon sp-water"></div><div class="sp-seg3"><div class="sp-seg"><i id="w1"></i></div><div class="sp-seg"><i id="w2"></i></div><div class="sp-seg"><i id="w3"></i></div></div></div>
        <div class="sp-row sp-grass"><div class="sp-icon sp-grass"></div><div class="sp-seg3"><div class="sp-seg"><i id="g1"></i></div><div class="sp-seg"><i id="g2"></i></div><div class="sp-seg"><i id="g3"></i></div></div></div>
      </div>
      <div class="sp-world" id="sp-world">
        <div class="sp-playground" id="sp-pg"></div>
      </div>
    </div>

    <!-- 🔰 新手指引（放在画布内，像素级对齐） -->
    <div id="guide-spirit" aria-hidden="true">
      <img id="guide-spirit-img" alt="guide">
      <button id="guide-spirit-skip">スキップ</button>
    </div>
  </div>

  <!-- 与后端通信 -->
  <script src="assets/api.js"></script>
  <script>
    /* ===== 登录与键名 ===== */
    const KEY_UID = 'zooUserId';
    const KEY_PROGRESS = 'zooGameProgress';
    function requireLogin(){
      const uid = localStorage.getItem(KEY_UID);
      if(!uid){ location.href='register.html'; throw new Error('no uid'); }
      return uid;
    }
    const USER_ID = requireLogin();

    /* ===== 本地读存档 ===== */
    const empty = {
      totalOpens:0,
      energy:{forest:0,water:0,grass:0},
      creatures:[{id:1,type:'neutral',stage:'juvenile',progress:0,splitDone:false}],
      nextId:2,
      nickname:''
    };
    function readLocal(){
      try{
        const s = JSON.parse(localStorage.getItem(KEY_PROGRESS)) || empty;
        // 确保 creatures 数组存在
        if (!s.creatures || !Array.isArray(s.creatures)) {
          s.creatures = empty.creatures;
        }
        s.creatures.forEach(c=>{
          if(typeof c.progress!=='number') c.progress=0;
          if(typeof c.splitDone!=='boolean') c.splitDone=false;
        });
        return s;
      }catch(e){ 
        console.log('Error reading local data:', e);
        return empty; 
      }
    }
    function writeLocal(state){
      localStorage.setItem(KEY_PROGRESS, JSON.stringify(state));
    }

    /* ===== 计算能量条 ===== */
    const LEVEL=3;
    function pickTarget(state,E){
      const byId=a=>a.sort((x,y)=>x.id-y.id)[0]||null;
      const j=byId(state.creatures.filter(c=>c.type===E&&c.stage==='juvenile'&&c.progress<LEVEL)); if(j) return j;
      const t=byId(state.creatures.filter(c=>c.type===E&&c.stage==='teen'&&c.progress<LEVEL));     if(t) return t;
      const a=byId(state.creatures.filter(c=>c.type===E&&c.stage==='adult'&&!c.splitDone&&c.progress<LEVEL)); if(a) return a;
      const n=state.creatures.find(c=>c.type==='neutral'&&c.stage==='juvenile'&&c.progress===0);  if(n) return n;
      return null;
    }
    function barState(state,E){
      const t=pickTarget(state,E);
      if(!t) return [0,0,0];
      if(t.type==='neutral') return [0,0,0];
      if(t.stage==='juvenile') return [t.progress/3,0,0];
      if(t.stage==='teen')     return [1,t.progress/3,0];
      if(t.stage==='adult'&&!t.splitDone) return [1,1,t.progress/3];
      return [0,0,0];
    }
    function renderBars(state){
      const map={forest:['f1','f2','f3'],water:['w1','w2','w3'],grass:['g1','g2','g3']};
      ['forest','water','grass'].forEach(E=>{
        const vals=barState(state,E);
        vals.forEach((v,i)=>{ document.getElementById(map[E][i]).style.width=(Math.max(0,Math.min(1,v))*100)+'%'; });
      });
    }

    /* ===== 精灵渲染与游走 ===== */
    const SPRITE_DIR='assets/sprites/';
    const SPRITE_SIZE={ neutral:{ juvenile: 90 }, forest:{ juvenile:95, teen:150, adult:250 }, water:{ juvenile:95, teen:130, adult:200 }, grass:{ juvenile:95, teen:120, adult:150 } };
    function spriteSrc(c,m){ 
      const src = c.type==='neutral' ? `${SPRITE_DIR}neutral_juvenile_${m}.GIF` : `${SPRITE_DIR}${c.type}_${c.stage}_${m}.GIF`;
      console.log(`spriteSrc(${c.type}, ${c.stage}, ${m}) = ${src}`);
      return src;
    }
    function spriteSize(c){ const w=(SPRITE_SIZE[c.type] && SPRITE_SIZE[c.type][c.stage]) || 120; return {w, h:w}; }
    const pg=document.getElementById('sp-pg');

    function createSprite(c){
      console.log('Creating sprite for creature:', c);
      const wrap=document.createElement('div'); wrap.className='sp-sprite';
      const {w,h}=spriteSize(c); wrap.style.width=w+'px'; wrap.style.height=h+'px';
      console.log('Sprite size:', {w, h});
      const area=pg.getBoundingClientRect(); const x=Math.random()*(area.width - w); const y=Math.random()*(area.height- h);
      wrap.style.left=x+'px'; wrap.style.top=y+'px';
      const img=document.createElement('img'); 
      const src = spriteSrc(c,'idle');
      console.log('Sprite src:', src);
      img.src=src; 
      img.alt=`${c.type}_${c.stage}`; 
      wrap.appendChild(img); 
      pg.appendChild(wrap);
      console.log('Sprite created and added to playground');

      let moving=true, vx=Math.random()*2-1, vy=Math.random()*2-1; const speed=16+Math.random()*20; let last=performance.now();
      function tick(now){ const dt=(now-last)/1000; last=now;
        if(moving){ let nx=parseFloat(wrap.style.left)+vx*speed*dt; let ny=parseFloat(wrap.style.top)+vy*speed*dt;
          const W=pg.clientWidth, H=pg.clientHeight; if(nx<0||nx>W-w){vx=-vx; nx=Math.max(0,Math.min(W-w,nx));} if(ny<0||ny>H-h){vy=-vy; ny=Math.max(0,Math.min(H-h,ny));}
          wrap.style.left=nx+'px'; wrap.style.top=ny+'px'; }
        requestAnimationFrame(tick);
      } requestAnimationFrame(tick);

      let downAt=0, happyTimer=null; const toIdle=()=>{img.src=spriteSrc(c,'idle')}; const toHappy=()=>{img.src=spriteSrc(c,'happy')};
      wrap.addEventListener('pointerdown',e=>{ e.preventDefault(); downAt=Date.now(); moving=false; clearTimeout(happyTimer); toHappy(); });
      function endPress(){ const held=Date.now()-downAt; downAt=0; happyTimer=setTimeout(()=>{ toIdle(); moving=true; }, held>=450?1000:2000); }
      wrap.addEventListener('pointerup',endPress); wrap.addEventListener('pointercancel',endPress); wrap.addEventListener('pointerleave',()=>{ if(downAt) endPress(); });
    }
    function renderSprites(state){ 
      console.log('Rendering sprites with state:', state);
      console.log('Creatures:', state.creatures);
      pg.innerHTML=''; 
      state.creatures.slice().sort((a,b)=>a.id-b.id).forEach(c=>{
        console.log('Creating sprite for:', c);
        createSprite(c);
      }); 
    }

    /* ===== 背景缩放与平移 ===== */
    const content=document.getElementById('sp-content'); const world=document.getElementById('sp-world'); const bg=document.getElementById('sp-bg'); const btnMap=document.getElementById('sp-btnMap');
    btnMap.addEventListener('click',()=>location.href='index.html');
    let scale=1, ox=0, oy=0; function applyTransform(){ world.style.transform=`translate(${ox}px,${oy}px) scale(${scale})`; bg.style.transform='none'; }

    const canvas=document.getElementById('sp-canvas'); let lastDist=0, lastCenter=null, isPanning=false, panStart=null, startOrigin=null;
    canvas.addEventListener('touchstart',e=>{ if(e.touches.length===2){ lastDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
        lastCenter={ x:(e.touches[0].clientX+e.touches[1].clientX)/2, y:(e.touches[0].clientY+e.touches[1].clientY)/2 }; }
      else if(e.touches.length===1){ isPanning=true; panStart={x:e.touches[0].clientX,y:e.touches[0].clientY}; startOrigin={x:ox,y:oy}; } },{passive:false});
    canvas.addEventListener('touchmove',e=>{ if(e.touches.length===2){ e.preventDefault();
        const dist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
        const ds=dist/lastDist; scale=Math.max(0.6,Math.min(2.2,scale*ds));
        const center={ x:(e.touches[0].clientX+e.touches[1].clientX)/2, y:(e.touches[0].clientY+e.touches[1].clientY)/2 };
        ox+=(center.x-lastCenter.x); oy+=(center.y-lastCenter.y); lastDist=dist; lastCenter=center; applyTransform();
      }else if(e.touches.length===1&&isPanning){ e.preventDefault(); ox=startOrigin.x+(e.touches[0].clientX-panStart.x); oy=startOrigin.y+(e.touches[0].clientY-panStart.y); applyTransform(); } },{passive:false});
    canvas.addEventListener('touchend',e=>{ if(e.touches.length<2){ lastDist=0; lastCenter=null; } if(e.touches.length===0){ isPanning=false; } });

    canvas.addEventListener('pointerdown',e=>{ if(e.pointerType!=='mouse') return; isPanning=true; panStart={x:e.clientX,y:e.clientY}; startOrigin={x:ox,y:oy}; });
    canvas.addEventListener('pointermove',e=>{ if(!isPanning||e.pointerType!=='mouse') return; ox=startOrigin.x+(e.clientX-panStart.x); oy=startOrigin.y+(e.clientY-panStart.y); applyTransform(); });
    canvas.addEventListener('pointerup',()=>{ isPanning=false; });

    /* ===== 进入页面：先云端→本地→渲染；渲染完成后再显示指引 ===== */
    async function init(){
      try{
        const { ok, progress } = await apiLoadProgress(USER_ID);
        console.log('API load result:', { ok, progress });
        if(ok && progress){ 
          console.log('Writing progress to local storage');
          writeLocal(progress); 
        }
      }catch(e){ 
        console.log('API load error:', e);
        /* 忽略网络错误，继续使用本地缓存 */ 
      }
      const state = readLocal();
      console.log('Local state:', state);
      renderBars(state);
      renderSprites(state);
      applyTransform();

      // ✅ 渲染完成后再检查是否显示指引
      showGuideIfNeeded();
    }
    init();

    // 指引函数（按需显示）
    function showGuideIfNeeded(){
      const steps=['assets/guide/spirit/step-1.png'];
      const KEY='guide:spirit:v3';
      const force=new URLSearchParams(location.search).has('tour');
      const seen=localStorage.getItem(KEY)==='1';
      if(seen && !force) return;

      const wrap=document.getElementById('guide-spirit');
      const img=document.getElementById('guide-spirit-img');
      const skip=document.getElementById('guide-spirit-skip');

      let i=0;
      function showStep(n){ img.src=steps[n]; }
      function closeGuide(){ wrap.classList.remove('show'); wrap.setAttribute('aria-hidden','true'); }
      function next(){
        i++;
        if(i<steps.length){ showStep(i); }
        else{ try{ localStorage.setItem(KEY,'1'); }catch(e){} closeGuide(); }
      }

      wrap.addEventListener('click', next);
      skip.addEventListener('click', e=>{ e.stopPropagation(); try{ localStorage.setItem(KEY,'1'); }catch(e){} closeGuide(); });

      showStep(0);
      wrap.classList.add('show');
      wrap.setAttribute('aria-hidden','false');
    }
  </script>
</body>
</html>
