<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>精霊センター</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .sp-btn-map{ position:absolute; right:20px; top:20px; z-index:9; width:72px; height:72px; background:url('assets/ui/btn_map.png') center/contain no-repeat; border:none; outline:none; cursor:pointer; }
    .sp-title{ position:absolute; left:28px; top:24px; width:280px; height:90px; background:url('assets/ui/title_seirei_garden.png') left top / contain no-repeat; }
    .sp-bars{ position:absolute; left:110px; top:160px; width:520px; }
    .sp-row{ display:flex; align-items:center; gap:12px; margin:22px 0; }
    .sp-row .sp-icon{ width:40px; height:40px; background-size:contain; background-repeat:no-repeat; background-position:center; flex:0 0 40px; }
    .sp-row .sp-icon.sp-forest{ background-image:url('assets/ui/icon_forest.png'); }
    .sp-row .sp-icon.sp-water { background-image:url('assets/ui/icon_water.png'); }
    .sp-row .sp-icon.sp-grass { background-image:url('assets/ui/icon_grass.png'); }
    .sp-seg3{ display:flex; gap:14px; }
    .sp-seg{ width:128px; height:22px; border-radius:12px; background:rgba(255,255,255,0.65); box-shadow:inset 0 0 0 2px rgba(0,0,0,0.08); overflow:hidden; }
    .sp-seg i{ display:block; height:100%; width:0%; }
    .sp-forest .sp-seg i{ background:#2f8f3a; }
    .sp-water  .sp-seg i{ background:#2da8f8; }
    .sp-grass  .sp-seg i{ background:#87c96a; }
    .sp-sprite{ position:absolute; pointer-events:auto; user-select:none; transform:translate3d(0,0,0); }
    .sp-sprite img{ width:100%; height:100%; display:block; pointer-events:none; }

    /* 画布内的引导层（与画布一起缩放） */
    #guide-spirit{ z-index:var(--z-guide); }
    #guide-spirit .guide-skip{ z-index:var(--z-guide-ui); }
  </style>
</head>
<body class="page">
  <div class="stage-fixed-outer">
    <div class="stage-fixed-canvas" id="sp-canvas">
      <div class="sp-bg" id="sp-bg" style="background:url('assets/bg/garden.jpg') center/cover no-repeat;"></div>
      <button class="sp-btn-map" id="sp-btnMap" title="マップへ"></button>

      <div class="sp-content" id="sp-content">
        <div class="sp-title"></div>
        <div class="sp-bars">
          <div class="sp-row sp-forest"><div class="sp-icon sp-forest"></div><div class="sp-seg3"><div class="sp-seg"><i id="f1"></i></div><div class="sp-seg"><i id="f2"></i></div><div class="sp-seg"><i id="f3"></i></div></div></div>
          <div class="sp-row sp-water"><div class="sp-icon sp-water"></div><div class="sp-seg3"><div class="sp-seg"><i id="w1"></i></div><div class="sp-seg"><i id="w2"></i></div><div class="sp-seg"><i id="w3"></i></div></div></div>
          <div class="sp-row sp-grass"><div class="sp-icon sp-grass"></div><div class="sp-seg3"><div class="sp-seg"><i id="g1"></i></div><div class="sp-seg"><i id="g2"></i></div><div class="sp-seg"><i id="g3"></i></div></div></div>
        </div>
        <div class="sp-playground" id="sp-pg"></div>
      </div>

      <!-- 🔰 引导蒙层（画布内；随画布缩放；层级最高） -->
      <section class="guide-layer" id="guide-spirit" aria-hidden="true">
        <img id="guide-spirit-img" alt="guide">
        <button class="guide-skip" id="guide-spirit-skip">スキップ</button>
      </section>
    </div>
  </div>

  <script>
    const KEY_UID='zooUserId';
    (function(){ const uid=localStorage.getItem(KEY_UID); if(!uid){ location.href='register.html'; } })();

    const KEY='zooGameProgress';
    const empty={ totalOpens:0, energy:{forest:0,water:0,grass:0}, creatures:[{id:1,type:'neutral',stage:'juvenile',progress:0,splitDone:false}], nextId:2, nickname:'' };
    function read(){ try{ const s=JSON.parse(localStorage.getItem(KEY))||empty; (s.creatures||[]).forEach(c=>{ if(typeof c.progress!=='number') c.progress=0; if(typeof c.splitDone!=='boolean') c.splitDone=false; }); return s; }catch{ return empty; } }

    const LEVEL=3;
    function pickTarget(state,E){
      const byId=a=>a.sort((x,y)=>x.id-y.id)[0]||null;
      const j=byId(state.creatures.filter(c=>c.type===E&&c.stage==='juvenile'&&c.progress<LEVEL)); if(j) return j;
      const t=byId(state.creatures.filter(c=>c.type===E&&c.stage==='teen'&&c.progress<LEVEL));     if(t) return t;
      const a=byId(state.creatures.filter(c=>c.type===E&&c.stage==='adult'&&!c.splitDone&&c.progress<LEVEL)); if(a) return a;
      const n=state.creatures.find(c=>c.type==='neutral'&&c.stage==='juvenile'&&c.progress===0);  if(n) return n;
      return null;
    }
    function barState(state,E){
      const t=pickTarget(state,E);
      if(!t) return [0,0,0];
      if(t.type==='neutral') return [0,0,0];
      if(t.stage==='juvenile') return [t.progress/3,0,0];
      if(t.stage==='teen')     return [1,t.progress/3,0];
      if(t.stage==='adult'&&!t.splitDone) return [1,1,t.progress/3];
      return [0,0,0];
    }
    function renderBars(state){
      const map={forest:['f1','f2','f3'],water:['w1','w2','w3'],grass:['g1','g2','g3']};
      ['forest','water','grass'].forEach(E=>{
        const vals=barState(state,E);
        vals.forEach((v,i)=>{ document.getElementById(map[E][i]).style.width=(Math.max(0,Math.min(1,v))*100)+'%'; });
      });
    }

    /* GIF 路径：先尝试小写，失败再尝试大写（容错，便于你逐步统一到 .gif） */
    const SPRITE_DIR='assets/sprites/';
    const SPRITE_SIZE={ neutral:{ juvenile: 90 }, forest:{ juvenile:95, teen:150, adult:250 }, water:{ juvenile:95, teen:130, adult:200 }, grass:{ juvenile:95, teen:120, adult:150 } };
    function spriteSrcLower(c,m){ if(c.type==='neutral') return `${SPRITE_DIR}neutral_juvenile_${m}.gif`; return `${SPRITE_DIR}${c.type}_${c.stage}_${m}.gif`; }
    function spriteSrcUpper(c,m){ if(c.type==='neutral') return `${SPRITE_DIR}neutral_juvenile_${m}.GIF`; return `${SPRITE_DIR}${c.type}_${c.stage}_${m}.GIF`; }
    function spriteSize(c){ const w=(SPRITE_SIZE[c.type] && SPRITE_SIZE[c.type][c.stage]) || 120; return {w, h:w}; }

    const pg=document.getElementById('sp-pg');
    function createSprite(c){
      const wrap=document.createElement('div'); wrap.className='sp-sprite';
      const {w,h}=spriteSize(c); wrap.style.width=w+'px'; wrap.style.height=h+'px';
      const area=pg.getBoundingClientRect(); const x=Math.max(0, Math.random()*(area.width - w)); const y=Math.max(0, Math.random()*(area.height- h));
      wrap.style.left=x+'px'; wrap.style.top=y+'px';
      const img=document.createElement('img'); img.src=spriteSrcLower(c,'idle'); img.alt=`${c.type}_${c.stage}`;
      img.onerror=()=>{ if(img.src.endsWith('.gif')) img.src=img.src.slice(0,-4)+'.GIF'; }; /* 小写失败→大写 */
      wrap.appendChild(img); pg.appendChild(wrap);

      let moving=true, vx=Math.random()*2-1, vy=Math.random()*2-1; const speed=16+Math.random()*20; let last=performance.now();
      function tick(now){ const dt=(now-last)/1000; last=now;
        if(moving){ let nx=parseFloat(wrap.style.left)+vx*speed*dt; let ny=parseFloat(wrap.style.top)+vy*speed*dt;
          const W=pg.clientWidth, H=pg.clientHeight; if(nx<0||nx>W-w){vx=-vx; nx=Math.max(0,Math.min(W-w,nx));} if(ny<0||ny>H-h){vy=-vy; ny=Math.max(0,Math.min(H-h,ny));}
          wrap.style.left=nx+'px'; wrap.style.top=ny+'px'; }
        requestAnimationFrame(tick);
      } requestAnimationFrame(tick);

      let downAt=0, happyTimer=null;
      const toIdle=()=>{ img.src=spriteSrcLower(c,'idle'); img.onerror=()=>{ if(img.src.endsWith('.gif')) img.src=img.src.slice(0,-4)+'.GIF'; }; };
      const toHappy=()=>{ img.src=spriteSrcLower(c,'happy'); img.onerror=()=>{ if(img.src.endsWith('.gif')) img.src=img.src.slice(0,-4)+'.GIF'; }; };
      wrap.addEventListener('pointerdown',e=>{ e.preventDefault(); downAt=Date.now(); moving=false; clearTimeout(happyTimer); toHappy(); });
      function endPress(){ const held=Date.now()-downAt; downAt=0; happyTimer=setTimeout(()=>{ toIdle(); moving=true; }, held>=450?1000:2000); }
      wrap.addEventListener('pointerup',endPress); wrap.addEventListener('pointercancel',endPress); wrap.addEventListener('pointerleave',()=>{ if(downAt) endPress(); });
    }
    function renderSprites(state){ pg.innerHTML=''; state.creatures.slice().sort((a,b)=>a.id-b.id).forEach(c=>createSprite(c)); }

    /* 平移/缩放（画布内容层） */
    const content=document.getElementById('sp-content'); const bg=document.getElementById('sp-bg'); const btnMap=document.getElementById('sp-btnMap');
    btnMap.addEventListener('click',()=>location.href='index.html');
    let scale=1, ox=0, oy=0; function applyTransform(){ content.style.transform=`translate(${ox}px,${oy}px) scale(${scale})`; bg.style.transform=`translate(${ox}px,${oy}px) scale(${scale})`; }
    const canvas=document.getElementById('sp-canvas'); let lastDist=0, lastCenter=null, isPanning=false, panStart=null, startOrigin=null;
    canvas.addEventListener('touchstart',e=>{ if(e.touches.length===2){ lastDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
        lastCenter={ x:(e.touches[0].clientX+e.touches[1].clientX)/2, y:(e.touches[0].clientY+e.touches[1].clientY)/2 }; }
      else if(e.touches.length===1){ isPanning=true; panStart={x:e.touches[0].clientX,y:e.touches[0].clientY}; startOrigin={x:ox,y:oy}; } },{passive:false});
    canvas.addEventListener('touchmove',e=>{ if(e.touches.length===2){ e.preventDefault();
        const dist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
        const ds=dist/lastDist; scale=Math.max(0.6,Math.min(2.2,scale*ds));
        const center={ x:(e.touches[0].clientX+e.touches[1].clientX)/2, y:(e.touches[0].clientY+e.touches[1].clientY)/2 };
        ox+=(center.x-lastCenter.x); oy+=(center.y-lastCenter.y); lastDist=dist; lastCenter=center; applyTransform();
      }else if(e.touches.length===1&&isPanning){ e.preventDefault(); ox=startOrigin.x+(e.touches[0].clientX-panStart.x); oy=startOrigin.y+(e.touches[0].clientY-panStart.y); applyTransform(); } },{passive:false});
    canvas.addEventListener('touchend',e=>{ if(e.touches.length<2){ lastDist=0; lastCenter=null; } if(e.touches.length===0){ isPanning=false; } });
    canvas.addEventListener('pointerdown',e=>{ if(e.pointerType!=='mouse') return; isPanning=true; panStart={x:e.clientX,y:e.clientY}; startOrigin={x:ox,y:oy}; });
    canvas.addEventListener('pointermove',e=>{ if(!isPanning||e.pointerType!=='mouse') return; ox=startOrigin.x+(e.clientX-panStart.x); oy=startOrigin.y+(e.clientY-panStart.y); applyTransform(); });
    canvas.addEventListener('pointerup',()=>{ isPanning=false; });

    /* 渲染 */
    const state=read(); renderBars(state); renderSprites(state); applyTransform();

    /* 引导：仅首次；?tour=1 强制显示；版本 v3 */
    (function(){
      const steps=['assets/guide/spirit/step-1.png'];
      const KEY='guide:spirit:v3';
      const force=new URLSearchParams(location.search).has('tour');
      const seen=localStorage.getItem(KEY)==='1';
      if(seen && !force) return;

      const wrap=document.getElementById('guide-spirit');
      const img=document.getElementById('guide-spirit-img');
      const skip=document.getElementById('guide-spirit-skip');

      let i=0;
      function showStep(n){ img.src=steps[n]; }
      function closeGuide(){ wrap.classList.remove('show'); wrap.setAttribute('aria-hidden','true'); }
      function next(){ i++; if(i<steps.length){ showStep(i); } else { try{ localStorage.setItem(KEY,'1'); }catch(e){} closeGuide(); } }

      wrap.addEventListener('click', next);
      skip.addEventListener('click', e=>{ e.stopPropagation(); try{ localStorage.setItem(KEY,'1'); }catch(e){} closeGuide(); });

      showStep(0); wrap.classList.add('show'); wrap.setAttribute('aria-hidden','false');
    })();
  </script>
</body>
</html>
