<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>奖励</title>
  <style>
         html,body{margin:0;background:#000;overflow:hidden;}
     .rw-root{width:100vw;height:100vh;margin:0;position:relative;background:#000;display:flex;flex-direction:column;overflow:hidden;}
     .rw-video{
       display:block;
       width:100%;
       height:100%;
       object-fit:cover;
       background:#000;
       /* 确保视频在所有设备上都能正确显示 */
       min-width: 100%;
       min-height: 100%;
       max-width: 100vw;
       max-height: 100vh;
     }
    .rw-white{position:absolute;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:10;transition:opacity 2s linear;}
    .rw-white.show{opacity:1;}
    .rw-showcase{position:absolute;inset:0;display:none;z-index:11;}
    .rw-showcase.show{display:block;}
    .rw-layer{position:absolute;left:0;right:0;display:flex;justify-content:center;pointer-events:none;}
    .rw-icon{top:17%; z-index:14;}
    .rw-power{top:25%; z-index:15;}
    .rw-glow{top:25%; z-index:11;}
    .rw-gradient{top:0; bottom:0; z-index:12; align-items:flex-end;}
    .rw-sprite{top:36%; z-index:13;}
    .rw-confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:20;}
    .rw-confetti i{position:absolute;width:8px;height:12px;border-radius:2px;opacity:.9;animation:fall 2.2s forwards ease-in;}
    @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg);}100%{transform:translateY(110vh) rotate(540deg);opacity:0;}}
         .rw-btn-wrap{position:absolute;left:0;right:0;top:63%;display:flex;justify-content:center;z-index:16;}
     .rw-btn{pointer-events:auto;border:none;background:transparent;padding:0;cursor:pointer;}
     .rw-btn img{display:block;width:clamp(150px, 30vw, 211.2px);height:auto;}
     .rw-icon img{width:clamp(50px, 10vw, 72px);height:auto;}
     .rw-power img{width:clamp(300px, 60vw, 440px);height:auto;}
     .rw-glow img{width:clamp(400px, 80vw, 558px);height:auto;}
     .rw-sprite img{width:clamp(180px, 35vw, 240px);height:auto;}
           .rw-gradient img{
        width: 120vw;
        height: 120vh;
        object-fit: cover;
        position: absolute;
        top: -10vh;
        left: -10vw;
        margin: 0;
        padding: 0;
        transform: scale(1.2);
      }
         .rw-audio-tip{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:9;padding:20px;}
    .rw-audio-tip.show{display:flex;}
         .rw-audio-tip button{pointer-events:auto;display:flex;align-items:center;gap:10px;padding:clamp(8px, 2vw, 12px) clamp(12px, 3vw, 16px);border-radius:999px;border:0;cursor:pointer;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);color:#fff;font-size:clamp(14px, 3vw, 16px);line-height:1;box-shadow:0 6px 16px rgba(0,0,0,.35);}
          .rw-audio-tip svg{width:clamp(18px, 4vw, 22px);height:clamp(18px, 4vw, 22px);display:block}
     
                       /* 移动设备优化 */
      @media (max-width: 768px) {
        .rw-root {
          width: 100vw;
          height: 100vh;
        }
        .rw-video {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        .rw-gradient img {
          width: 130vw;
          height: 130vh;
          object-fit: cover;
          position: absolute;
          top: -15vh;
          left: -15vw;
          margin: 0;
          padding: 0;
          transform: scale(1.3);
        }
        .rw-layer {
          transform: scale(0.85);
        }
        .rw-btn-wrap {
          top: 65%;
        }
      }
      
      /* 小屏幕设备优化 */
      @media (max-width: 480px) {
        .rw-video {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        .rw-gradient img {
          width: 140vw;
          height: 140vh;
          object-fit: cover;
          position: absolute;
          top: -20vh;
          left: -20vw;
          margin: 0;
          padding: 0;
          transform: scale(1.4);
        }
        .rw-layer {
          transform: scale(0.75);
        }
        .rw-btn-wrap {
          top: 70%;
        }
        .rw-icon {
          top: 15%;
        }
        .rw-power {
          top: 22%;
        }
        .rw-glow {
          top: 22%;
        }
        .rw-sprite {
          top: 32%;
        }
      }
      
      /* 超小屏幕设备优化 */
      @media (max-width: 360px) {
        .rw-gradient img {
          width: 150vw;
          height: 150vh;
          object-fit: cover;
          position: absolute;
          top: -25vh;
          left: -25vw;
          margin: 0;
          padding: 0;
          transform: scale(1.5);
        }
        .rw-layer {
          transform: scale(0.65);
        }
        .rw-btn-wrap {
          top: 75%;
        }
        .rw-icon {
          top: 12%;
        }
        .rw-power {
          top: 18%;
        }
        .rw-glow {
          top: 18%;
        }
        .rw-sprite {
          top: 28%;
        }
      }
      
             /* 横屏模式优化 */
      @media (orientation: landscape) and (max-height: 500px) {
        .rw-video {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        .rw-gradient img {
          width: 160vw;
          height: 160vh;
          object-fit: cover;
          position: absolute;
          top: -30vh;
          left: -30vw;
          margin: 0;
          padding: 0;
          transform: scale(1.6);
        }
        .rw-layer {
          transform: scale(0.6);
        }
        .rw-btn-wrap {
          top: 80%;
        }
        .rw-icon {
          top: 10%;
        }
        .rw-power {
          top: 15%;
        }
        .rw-glow {
          top: 15%;
        }
        .rw-sprite {
          top: 25%;
        }
      }
      
      /* 确保在所有设备上视频都能正确显示 */
      @media (max-aspect-ratio: 9/16) {
        .rw-video {
          object-fit: cover;
        }
      }
      
      @media (min-aspect-ratio: 9/16) {
        .rw-video {
          object-fit: cover;
        }
      }
      
      /* 防止iOS Safari的地址栏影响布局 */
      @supports (padding: max(0px)) {
        .rw-root {
          padding-left: env(safe-area-inset-left);
          padding-right: env(safe-area-inset-right);
          padding-top: env(safe-area-inset-top);
          padding-bottom: env(safe-area-inset-bottom);
        }
      }
      
             /* 确保在移动设备上禁用用户选择 */
       .rw-root {
         -webkit-user-select: none;
         -moz-user-select: none;
         -ms-user-select: none;
         user-select: none;
         -webkit-touch-callout: none;
         -webkit-tap-highlight-color: transparent;
       }
       
               /* 确保视频和渐变背景图在所有设备上都能正确显示 */
        @media (max-width: 320px) {
          .rw-video {
            object-fit: cover;
            width: 100vw;
            height: 100vh;
          }
          .rw-gradient img {
            width: 160vw;
            height: 160vh;
            object-fit: cover;
            position: absolute;
            top: -30vh;
            left: -30vw;
            margin: 0;
            padding: 0;
            transform: scale(1.6);
          }
        }
        
        @media (min-width: 321px) and (max-width: 480px) {
          .rw-video {
            object-fit: cover;
            width: 100vw;
            height: 100vh;
          }
          .rw-gradient img {
            width: 150vw;
            height: 150vh;
            object-fit: cover;
            position: absolute;
            top: -25vh;
            left: -25vw;
            margin: 0;
            padding: 0;
            transform: scale(1.5);
          }
        }
        
        @media (min-width: 481px) and (max-width: 768px) {
          .rw-video {
            object-fit: cover;
            width: 100vw;
            height: 100vh;
          }
          .rw-gradient img {
            width: 140vw;
            height: 140vh;
            object-fit: cover;
            position: absolute;
            top: -20vh;
            left: -20vw;
            margin: 0;
            padding: 0;
            transform: scale(1.4);
          }
        }
        
                                                                                                                                               @media (min-width: 769px) {
             .rw-root {
               width: 50vw;
               height: 100vh;
               position: fixed;
               left: 50%;
               top: 0;
               transform: translateX(-50%);
             }
            
            .rw-video {
              object-fit: cover;
              width: 100%;
              height: 100%;
            }
            
            .rw-gradient img {
              width: 100%;
              height: 100%;
              object-fit: cover;
              position: absolute;
              top: 0;
              left: 0;
              margin: 0;
              padding: 0;
              transform: none;
            }
            
            /* 电脑端组件缩小 */
            .rw-btn img {
              width: 120px;
              height: auto;
            }
            
            .rw-icon img {
              width: 35px;
              height: auto;
            }
            
            .rw-power img {
              width: 240px;
              height: auto;
            }
            
            .rw-glow img {
              width: 320px;
              height: auto;
            }
            
            .rw-sprite img {
              width: 160px;
              height: auto;
            }
            
            /* 调整位置 */
            .rw-btn-wrap {
              top: 65%;
            }
            
            .rw-icon {
              top: 15%;
            }
            
            .rw-power {
              top: 22%;
            }
            
            .rw-glow {
              top: 22%;
            }
            
            .rw-sprite {
              top: 32%;
            }
          }
        
                           /* 大屏幕电脑端优化 */
          @media (min-width: 1200px) {
            .rw-btn img {
              width: 140px;
              height: auto;
            }
            
            .rw-icon img {
              width: 40px;
              height: auto;
            }
            
            .rw-power img {
              width: 280px;
              height: auto;
            }
            
            .rw-glow img {
              width: 360px;
              height: auto;
            }
            
            .rw-sprite img {
              width: 180px;
              height: auto;
            }
          }
          
          /* 超宽屏适配 */
          @media (min-width: 1600px) {
            .rw-btn img {
              width: 160px;
              height: auto;
            }
            
            .rw-icon img {
              width: 45px;
              height: auto;
            }
            
            .rw-power img {
              width: 320px;
              height: auto;
            }
            
            .rw-glow img {
              width: 400px;
              height: auto;
            }
            
            .rw-sprite img {
              width: 200px;
              height: auto;
            }
          }
          
                  /* 横屏模式特殊处理 */
          @media (orientation: landscape) and (max-width: 768px) {
           .rw-video {
             object-fit: cover;
             width: 100vw;
             height: 100vh;
           }
           .rw-gradient img {
             width: 170vw;
             height: 170vh;
             object-fit: cover;
             position: absolute;
             top: -35vh;
             left: -35vw;
             margin: 0;
             padding: 0;
             transform: scale(1.7);
           }
         }
   </style>
</head>
<body>
  <div class="rw-root">
    <video id="rwVideo" class="rw-video" playsinline webkit-playsinline muted></video>
    <div id="rwAudioTip" class="rw-audio-tip">
      <button id="rwAudioBtn" title="サウンドON">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M3 10v4a1 1 0 0 0 1 1h3l4.293 4.293A1 1 0 0 0 13 18V6a1 1 0 0 0-1.707-.707L7 9H4a1 1 0 0 0-1 1z"/>
          <path d="M16.5 8.5a4 4 0 0 1 0 7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M18.5 6.5a7 7 0 0 1 0 11" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        サウンドON
      </button>
    </div>
    <div id="rwWhite" class="rw-white"></div>
    <div id="rwShow" class="rw-showcase">
      <div class="rw-layer rw-glow"><img id="imgGlow" alt="glow"></div>
      <div class="rw-layer rw-gradient" style="align-items:flex-end"><img id="imgGrad" alt="overlay"></div>
      <div class="rw-layer rw-sprite"><img id="imgSprite" alt="sprite"></div>
      <div class="rw-layer rw-icon"><img id="imgIcon" alt="icon"></div>
      <div class="rw-layer rw-power"><img id="imgPower" alt="power +1"></div>
      <div id="rwConfetti" class="rw-confetti"></div>
      <div class="rw-btn-wrap"><button id="btnGo" class="rw-btn" title="せいれいガーデン"><img id="imgBtn" alt="seirei garden"></button></div>
    </div>
  </div>

  <!-- 引入 API -->
  <script src="assets/api.js"></script>
  <script>
    const KEY_UID = 'zooUserId';
    const KEY_PROGRESS = 'zooGameProgress';
    function requireLogin(){
      const uid = localStorage.getItem(KEY_UID);
      if(!uid){ location.href='register.html'; throw new Error('no uid'); }
      return uid;
    }
    const USER_ID = requireLogin();

    /* ===== 以下为奖励页逻辑 ===== */
    const VIDEO_BY_CHEST={forest:'videos/reward_forest.mp4',water:'videos/reward_water.mp4',grass:'videos/reward_grass.mp4'};
    const DEFAULT_VIDEO='videos/reward_default.mp4';
    const ASSETS={ icon:{forest:'assets/ui/icon_forest.png',water:'assets/ui/icon_water.png',grass:'assets/ui/icon_grass.png'}, power:'assets/ui/power_plus.png', gradient:'assets/ui/reward_gradient_overlay.png', glow:'assets/effects/glow_loop.GIF', btn:'assets/ui/btn_seirei_garden.png' };
    const SPRITES_DIR='assets/sprites/';
    function spriteHappy(type,stage){ if(type==='neutral') return SPRITES_DIR+'neutral_juvenile_happy.GIF'; return `${SPRITES_DIR}${type}_${stage}_happy.GIF`; }

    const initState={totalOpens:0,energy:{forest:0,water:0,grass:0},creatures:[{id:1,type:'neutral',stage:'juvenile',progress:0,splitDone:false}],nextId:2,nickname:''};
    function read(){try{const s=JSON.parse(localStorage.getItem(KEY_PROGRESS))||structuredClone(initState); (s.creatures||[]).forEach(c=>{if(typeof c.progress!=='number')c.progress=0;if(typeof c.splitDone!=='boolean')c.splitDone=false;}); return s;}catch{return structuredClone(initState);}}
    function write(state){ localStorage.setItem(KEY_PROGRESS, JSON.stringify(state)); }

    const LEVEL=3;
    function pickTarget(state,E){
      const byId=a=>a.sort((x,y)=>x.id-y.id)[0]||null;
      const j=byId(state.creatures.filter(c=>c.type===E&&c.stage==='juvenile'&&c.progress<LEVEL)); if(j) return j;
      const t=byId(state.creatures.filter(c=>c.type===E&&c.stage==='teen'&&c.progress<LEVEL));     if(t) return t;
      const a=byId(state.creatures.filter(c=>c.type===E&&c.stage==='adult'&&!c.splitDone&&c.progress<LEVEL)); if(a) return a;
      const n=state.creatures.find(c=>c.type==='neutral'&&c.stage==='juvenile'&&c.progress===0); if(n) return n;
      return null;
    }
    function giveEnergyOnce(state,E){
      const events=[]; const target=pickTarget(state,E);
      if(target){
        if(target.type==='neutral'){const before={...target};target.type=E;target.progress=1;events.push({kind:'bind',from:before,to:{...target}});return events;}
        target.progress++;
        if(target.stage==='juvenile'&&target.progress>=LEVEL){const before={...target};target.stage='teen';target.progress=0;events.push({kind:'evolve',from:before,to:{...target}});}
        else if(target.stage==='teen'&&target.progress>=LEVEL){const before={...target};target.stage='adult';target.progress=0;target.splitDone=false;events.push({kind:'evolve',from:before,to:{...target}});}
        else if(target.stage==='adult'&&!target.splitDone&&target.progress>=LEVEL){const parentBefore={...target};target.progress=0;target.splitDone=true;const newborn={id:state.nextId++,type:'neutral',stage:'juvenile',progress:0,splitDone:false};state.creatures.push(newborn);events.push({kind:'split',parent:parentBefore,newborn:{...newborn}});}
        return events;
      }
      const newborn={id:state.nextId++,type:E,stage:'juvenile',progress:1,splitDone:false};state.creatures.push(newborn);events.push({kind:'spawn',newborn:{...newborn}});return events;
    }

    const params=new URLSearchParams(location.search);
    const chest=(params.get('chest')||'unknown').toLowerCase();
    const videoEl=document.getElementById('rwVideo');
    const whiteEl=document.getElementById('rwWhite');
    const showEl=document.getElementById('rwShow');
    const confettiC=document.getElementById('rwConfetti');
    const imgIcon=document.getElementById('imgIcon');
    const imgPower=document.getElementById('imgPower');
    const imgGlow=document.getElementById('imgGlow');
    const imgGrad=document.getElementById('imgGrad');
    const imgSprite=document.getElementById('imgSprite');
    const imgBtn=document.getElementById('imgBtn');
    const btnGo=document.getElementById('btnGo');
    const audioTip = document.getElementById('rwAudioTip');
    const audioBtn = document.getElementById('rwAudioBtn');

    imgPower.src=ASSETS.power; imgGrad.src=ASSETS.gradient; imgGlow.src=ASSETS.glow; imgBtn.src =ASSETS.btn; imgIcon.src=ASSETS.icon[chest] || ASSETS.icon.forest;
    btnGo.addEventListener('click',()=>location.href='spirit.html');

    let rewardApplied=false, overlayStarted=false, overlayShown=false;
    function applyRewardOnce(){
      if(rewardApplied) return [];
      rewardApplied=true;
      const st=read(); st.totalOpens+=1; if(!st.energy[chest]) st.energy[chest]=0; st.energy[chest]+=1;
      let ev=[]; if(['forest','water','grass'].includes(chest)) ev=giveEnergyOnce(st,chest);
      write(st);

      // ★ 新增：保存到云端
      apiSaveProgress(USER_ID, st).catch(()=>{});

      setSpriteFromEvents(ev); return ev;
    }
    function setSpriteFromEvents(events){
      let type='neutral', stage='juvenile';
      const eEvo=events.find(e=>e.kind==='evolve'), eSpl=events.find(e=>e.kind==='split'), eBind=events.find(e=>e.kind==='bind'), eSpwn=events.find(e=>e.kind==='spawn');
      if(eEvo){ type=eEvo.to.type; stage=eEvo.to.stage; }
      else if(eSpl){ type='neutral'; stage='juvenile'; }
      else if(eBind){ type=eBind.to.type; stage='juvenile'; }
      else if(eSpwn){ type=eSpwn.newborn.type; stage='juvenile'; }
      imgSprite.src = spriteHappy(type, stage);
    }
    function startOverlay(){
      if(overlayStarted) return; overlayStarted=true;
      applyRewardOnce();
      whiteEl.classList.add('show');
      const done = ()=>{ if(overlayShown) return; overlayShown=true; showEl.classList.add('show'); startConfetti(); };
      whiteEl.addEventListener('transitionend', done, {once:true});
      setTimeout(done, 2100);
    }

    async function playWithSound(){
      try{ videoEl.muted = false; await videoEl.play(); audioTip.classList.remove('show'); }
      catch{ try{ videoEl.muted = true; await videoEl.play(); }catch{} audioTip.classList.add('show');
        const enable = ()=>{ videoEl.muted = false; videoEl.play().catch(()=>{}); audioTip.classList.remove('show'); document.removeEventListener('click', enable); document.removeEventListener('touchstart', enable); };
        audioBtn.addEventListener('click', enable, {once:true}); document.addEventListener('click', enable, {once:true}); document.addEventListener('touchstart', enable, {once:true});
      }
    }
    function wireVideo(){
      const src=VIDEO_BY_CHEST[chest] || DEFAULT_VIDEO;
      console.log('Loading video for chest:', chest, 'src:', src);
      videoEl.src=src; 
      videoEl.playsInline=true; 
      
      // 添加视频加载事件监听
      videoEl.addEventListener('loadstart', () => console.log('Video load started'));
      videoEl.addEventListener('loadeddata', () => console.log('Video data loaded'));
      videoEl.addEventListener('canplay', () => console.log('Video can play'));
      videoEl.addEventListener('error', (e) => console.error('Video error:', e));
      
      playWithSound();
      let duration=NaN; 
      videoEl.addEventListener('loadedmetadata',()=>{
        duration=videoEl.duration||NaN;
        console.log('Video duration:', duration, 'Video dimensions:', videoEl.videoWidth, 'x', videoEl.videoHeight);
      });
      videoEl.addEventListener('timeupdate',()=>{ if(!overlayStarted && isFinite(duration) && duration - videoEl.currentTime <= 2.0){ startOverlay(); } });
      videoEl.addEventListener('ended',()=>{ if(!overlayStarted) startOverlay(); });
      setTimeout(()=>{ if(!overlayStarted) startOverlay(); }, 4500);
    }

    let confettiTimer=null;
    function spawnConfettiBurst(k=14){
      const colors=['#ff7676','#ffd166','#06d6a0','#118ab2','#9b5de5','#f15bb5','#ffc6ff'];
      const w=confettiC.clientWidth||720;
      for(let i=0;i<k;i++){
        const p=document.createElement('i');
        p.style.left=(Math.random()*w)+'px';
        p.style.background=colors[(Math.random()*colors.length)|0];
        p.style.animationDelay=(Math.random()*0.35)+'s';
        p.style.animationDuration=(1.8+Math.random()*1.4)+'s';
        p.addEventListener('animationend',()=>p.remove());
        confettiC.appendChild(p);
      }
    }
    function startConfetti(totalMs=2400, intervalMs=160, perBurst=12){
      spawnConfettiBurst(perBurst);
      confettiTimer=setInterval(()=>spawnConfettiBurst(perBurst), intervalMs);
      setTimeout(()=>{ if(confettiTimer){clearInterval(confettiTimer);confettiTimer=null;} }, totalMs);
    }
    wireVideo();
  </script>
</body>
</html>
