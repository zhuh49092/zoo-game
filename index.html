<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>夢見ヶ崎動物勇者団｜マップ</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    /* 仅页面特有的小差异保留在这里（图标素材路径等） */
    .pin-forest{ background-image:url('assets/icons/chest_forest.png'); }
    .pin-grass { background-image:url('assets/icons/chest_grass.png'); }
    .pin-water { background-image:url('assets/icons/chest_water.png'); }
    .pin-scroll{ background-image:url('assets/icons/scroll.png'); }
  </style>
</head>
<body class="page" style="background:#fef9f1">
  <!-- 左侧浮动快捷按钮（层级 < 蒙层） -->
  <nav class="floating-nav" aria-label="ショートカット">
    <a href="spirit.html" aria-label="精霊センター"><img src="assets/ui/btn_spirit.png" alt="精霊センター"></a>
    <a href="https://padlet.com/dchen85/zoo-padlet-l71381k577vyh6xb" target="_blank" rel="noopener" aria-label="宝物ホール（Padlet）"><img src="assets/ui/btn_padlet.png" alt="宝物ホール"></a>
  </nav>

  <main class="stage-fluid" id="mapStage">
    <!-- 地图底图（跟舞台同一容器） -->
    <img src="assets/map.jpg" alt="Map" class="fill-cover" id="mapImg">

    <!-- 卷轴：活动中心 Padlet -->
    <a class="pin pin-scroll" style="left:76%; top:11%;" href="https://padlet.com/zhuh49092/padlet-g0d3l1jnxdv42n5q" target="_blank" rel="noopener noreferrer" title="イベント掲示板（Padlet）"></a>

    <!-- 宝箱入口（链接到各 Google Form，预填 UID） -->
    <a class="pin pin-water"  style="left:30%; top:27%;" href="#" onclick="openChest('water')"  title="水辺"></a>
    <a class="pin pin-grass"  style="left:60%; top:24%;" href="#" onclick="openChest('grass')"  title="草原"></a>
    <a class="pin pin-grass"  style="left:50%; top:46%;" href="#" onclick="openChest('grass')"  title="草原"></a>
    <a class="pin pin-forest" style="left:50%; top:10%;" href="#" onclick="openChest('forest')" title="森林"></a>
    <a class="pin pin-forest" style="left:82%; top:31%;" href="#" onclick="openChest('forest')" title="森林"></a>
    <a class="pin pin-forest" style="left:30%; top:65%;" href="#" onclick="openChest('forest')" title="森林"></a>

    <!-- 🔰 指引蒙层（与地图同容器 + 层级最高） -->
    <section class="guide-layer" id="guide-index" aria-hidden="true">
      <img id="guide-index-img" alt="guide">
      <button class="guide-skip" id="guide-index-skip">スキップ</button>
    </section>
  </main>

  <script>
    /* 登录校验（沿用你的 key） */
    const KEY_UID = 'zooUserId';
    (function requireLogin(){ const uid = localStorage.getItem(KEY_UID); if (!uid) { location.href = 'register.html'; } })();

    /* Google Forms 预填 UID（按你之前的结构） */
    const GOOGLE_FORMS = {
      forest: 'https://docs.google.com/forms/d/e/1FAIpQLSe-umCP58ragoaZpKCY7DI-4GkAK1GD9bXNpGb3uwuAKyVKIQ/viewform',
      water:  'https://docs.google.com/forms/d/e/1FAIpQLSehivQhizS3siNa_MnVH_NPTTpDhoco8n5-Mk09gTzeXQispQ/viewform',
      grass:  'https://docs.google.com/forms/d/e/1FAIpQLSf3xBbuJN6RPEa9qworZ_sGwDJnGJ6F6eeE5R9BVZVGqBxU7Q/viewform'
    };
    const USERID_ENTRY_IDS = { forest: 'entry.112735564', water: 'entry.1623179609', grass: 'entry.684988275' };
    function getUserId(){ return (localStorage.getItem(KEY_UID) || '').trim(); }
    function buildPrefilledUrl(type) {
      const base = GOOGLE_FORMS[type]; if (!base) return '';
      const entryId = USERID_ENTRY_IDS[type]; const uid = getUserId();
      if (!entryId || !uid) return base;
      const sep = base.includes('?') ? '&' : '?';
      return `${base}${sep}${encodeURIComponent(entryId)}=${encodeURIComponent(uid)}`;
    }
    function openChest(type){
      const url = buildPrefilledUrl(type);
      if(!url){ alert('この宝箱のフォーム URL が設定されていません'); return; }
      window.location.href = url;
    }

    /* 新手指引：仅首次；?tour=1 强制显示；版本号 v6 */
    (function(){
      const steps=[
        'assets/guide/index/step-1.png',
        'assets/guide/index/step-2.png',
        'assets/guide/index/step-3.png',
        'assets/guide/index/step-4.png'
      ];
      const KEY='guide:index:v6';
      const force=new URLSearchParams(location.search).has('tour');
      const seen=localStorage.getItem(KEY)==='1';
      if(seen && !force) return;

      const wrap=document.getElementById('guide-index');
      const img=document.getElementById('guide-index-img');
      const skip=document.getElementById('guide-index-skip');
      let i=0;

      function showStep(n){ img.src=steps[n]; }
      function closeGuide(){
        wrap.classList.remove('show');
        wrap.setAttribute('aria-hidden','true');
      }
      function next(){
        i++;
        if(i<steps.length){ showStep(i); }
        else { try{ localStorage.setItem(KEY,'1'); }catch(e){} closeGuide(); }
      }

      wrap.addEventListener('click', next);
      skip.addEventListener('click', e=>{ e.stopPropagation(); try{ localStorage.setItem(KEY,'1'); }catch(e){} closeGuide(); });

      showStep(0); wrap.classList.add('show'); wrap.setAttribute('aria-hidden','false');
    })();
  </script>
</body>
</html>
