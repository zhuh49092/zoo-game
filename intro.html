<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>イントロ</title>
  <link rel="stylesheet" href="assets/style.css"/>
  <style>
    .btn-pill{
      height:44px; padding:0 16px; border:0; border-radius:999px;
      font-size:18px; font-weight:700; color:#fff;
      background:rgba(0,0,0,.35); backdrop-filter:blur(4px);
      -webkit-tap-highlight-color:transparent; cursor:pointer;
    }
    #skip{ position:absolute; right:12px; top:calc(12px + env(safe-area-inset-top)); z-index:10; }
    #sound{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:9; }
  </style>
</head>
<body class="page">
  <main class="stage-fluid" id="introStage">
    <video id="intro" class="fill-cover" playsinline webkit-playsinline muted autoplay></video>
    <button id="skip" class="btn-pill">スキップ</button>
    <button id="sound" class="btn-pill">サウンドON</button>
    <button id="start" class="hide" aria-hidden="true" tabindex="-1"></button>
  </main>

  <script>
    const v = document.getElementById('intro');
    const skipBtn = document.getElementById('skip');
    const soundBtn = document.getElementById('sound');

    // 仅从注册/登录页来时追加时间戳，避免缓存
    (function setVideoSrc(){
      const BASE_SRC = 'assets/intro.mp4';
      const ref = document.referrer || '';
      const fromAuth = /\/register\.html($|\?)/.test(ref) || /\/login\.html($|\?)/.test(ref);
      const hinted = (new URLSearchParams(location.search)).get('from') === 'auth';
      v.src = (fromAuth || hinted) ? `${BASE_SRC}?v=${Date.now()}` : BASE_SRC;
    })();

    skipBtn.onclick = () => location.href = 'index.html';
    document.getElementById('start').onclick = () => location.href = 'index.html';
    v.addEventListener('ended', () => location.href = 'index.html');

    function hideSoundBtn(){ soundBtn.style.display = 'none'; }
    v.addEventListener('play', () => { if (!v.muted) hideSoundBtn(); });
    v.addEventListener('volumechange', () => { if (!v.muted && v.volume > 0) hideSoundBtn(); });
    soundBtn.addEventListener('click', async () => {
      try{ v.muted = false; v.volume = 1.0; await v.play(); hideSoundBtn(); }
      catch(e){ console.warn('Unmute failed:', e); }
    });
  </script>
</body>
</html>
